# 打车发票功能说明

## 功能概述
新增打车发票和行程单上传功能，用户可以在提交报销申请时标记为打车发票并上传相应的行程单。

## 实现的功能

### 1. 前端提交表单
- ✅ 新增复选框"这是打车发票"
- ✅ 勾选后自动显示行程单上传字段
- ✅ 行程单文件格式：PDF，最大50MB
- ✅ 支持新建和重新提交时上传/更新行程单

### 2. 后端数据存储
- ✅ 数据库新增字段：
  - `is_taxi_invoice`: 布尔型，标记是否为打车发票
  - `itinerary_pdf`: 文件字段，存储行程单PDF
- ✅ 行程单存储路径：`media/itineraries/`
- ✅ 自动删除旧文件：更新或删除申请时自动清理相关文件

### 3. 管理后台功能
- ✅ 列表页显示"是否打车发票"标识
- ✅ 详情页可查看和下载行程单
- ✅ 支持筛选打车发票
- ✅ 显示行程单文件信息（文件名、大小）
- ✅ 批量删除时自动清理行程单文件

### 4. 用户查看功能
- ✅ "我的申请"页面显示行程单下载链接（绿色按钮）
- ✅ 只有打车发票且上传了行程单才显示下载链接
- ✅ 重新提交时保留打车发票状态

## 技术实现

### 后端修改
1. **models.py**
   - 新增 `is_taxi_invoice` 和 `itinerary_pdf` 字段
   - 新增 `get_itinerary_path()` 函数生成行程单文件路径
   - 更新文件删除信号处理器

2. **serializers.py**
   - 更新序列化器以支持新字段
   - 添加 `itinerary_pdf_url` 方法返回完整URL
   - 更新 `update()` 方法处理行程单文件替换

3. **admin.py**
   - 列表显示添加 `is_taxi_invoice` 和行程单下载链接
   - 详情页添加行程单文件信息显示
   - 更新删除操作以清理行程单文件

### 前端修改
1. **ReimbursementForm.vue**
   - 添加打车发票复选框（蓝色背景高亮）
   - 条件显示行程单上传字段
   - 处理行程单文件上传和验证
   - 提交时包含打车发票标识和行程单

2. **MyReimbursements.vue**
   - 显示行程单下载按钮（绿色）
   - 重新提交时传递打车发票状态
   - 添加行程单链接样式

## 使用说明

### 用户操作流程
1. 在报销申请表单中勾选"🚕 这是打车发票"
2. 上传发票PDF（必需）
3. 上传行程单PDF（可选，但建议上传）
4. 填写其他必填信息后提交
5. 在"我的申请"页面可下载发票和行程单

### 管理员操作
1. 登录管理后台
2. 在报销申请列表可看到"是否打车发票"列
3. 点击进入详情页可查看和下载行程单
4. 审核通过后用户可下载行程单

## 文件存储
- 发票PDF：`media/invoices/`
- 行程单PDF：`media/itineraries/`
- 命名格式：`日期-姓名-事由-行程单-唯一ID.pdf`

## 注意事项
- 行程单仅在勾选"打车发票"时显示
- 文件大小限制：50MB
- 支持的格式：PDF
- 重新提交时可选择更换行程单
- 删除申请时自动删除相关文件
